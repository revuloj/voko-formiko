<project name="Revo-redaktilo" default="" basedir=".">
    <description>
       Reta Vortaro, reguloj por aktualigi dosierojn, datumbazojn de la redaktilo.
    </description>

 
   <!-- property file="etc -->
   <property environment="ENV"/>
   <property name="voko" value="${ENV.VOKO}"/>

   <property name="js_src" location="${voko}/swi/js_src"/>
   <property name="web" location="${voko}/swi/web"/>

   <!--property file="${user.home}/cfg/agordo" prefix="red."/ -->
   <!-- property name="etc" value="${voko.etc}"/ -->

   <property file="${user.home}/etc/redaktilo-agordo" prefix="red."/>
   <property name="tmp" location="${user.home}/tmp"/>
   <property name="sql_dir" location="${user.home}/sql"/>
   
   <property name="swipl" location="/usr/bin/swipl"/>
   <property name="sqlite3" location="/usr/bin/sqlite3"/>

   <property name="voko.bin" location="${voko}/bin"/>
   <property name="voko.smb" location="${voko}/smb"/>
   
   <property name="mpost" location="/usr/bin/mpost"/>
   <property name="rsvgconv" location="/usr/bin/rsvg-convert"/>

   <property name="closure-compiler" location="/usr/local/share/java/closure-compiler.jar"/>
   <path id="closure.classpath">
     <pathelement location="${closure-compiler}"/>
     <pathelement path="${java.class.path}"/>
   </path>

   
   
   <target name="red-preparo">
     <tstamp>
       <format property="red.dato" pattern="yyyyMMdd"/>
     </tstamp>

     <tstamp>
       <format property="red.tempo" pattern="HHmmss"/>
     </tstamp>

     <echo message="tempo: ${red.dato} ${red.tempo}"/>
   </target>


   <target name="red-agordo" description="eligas la agordeblajn variablojn por kontrolo">
     <echoproperties prefix="red."/>
   </target>


<!-- ################### prenado de redaktanto-listo ####################### -->

   <target name="red-redaktantoj" description="aktualigas datumbazon de redaktantoj el la Revo-servilo">
     <get src="${red.redaktantoj.url}" 
       dest="${red.redaktantoj.listo}" 
       username="${red.redaktantoj.user}"
       password="${red.redaktantoj.password}" verbose="true"/>

     <echo message="Aktualigi sql/redaktatoj.db per ${voko}/swi/redaktantoj.pl..."/>
     <exec executable="${swipl}">
       <arg value="-s"/>
       <arg file="${voko}/swi/redaktantoj.pl"/>
       <arg value="-g"/>
       <arg value="redaktantoj:update_redaktantoj,halt"/>
     </exec>
   </target>

   
   <target name="red-sqlitedb" description="aktualigas datumbazon de artikoloj el la Revo-servilo">
     <exec executable="${swipl}">
       <arg value="-s"/>
       <arg file="${voko}/swi/sqlrevo.pl"/>
       <arg value="-g"/>
       <arg value="sqlrevo:download,halt"/>
     </exec>

     <unzip src="${tmp}/revo-inx.db.tmp.zip" dest="${tmp}"/>
     <copy file="${tmp}/revo-inx.db" tofile="${sql_dir}/revo-inx.db" />
   </target>

   <target name="red-biblist" depends="red-preparo"
        description="kreas bibliografio-liston" >

      <xslt in="${voko}/cfg/bibliogr.xml" out="${voko}/cfg/biblist.xml"
	  style="${voko}/xsl/bibxml.xsl"/>
   </target>

   <target name="red-kls" depends="red-preparo"
        description="kreas liston de klasoj (vortlistoj) el rdf" >

     <xslt in="${voko}/owl/voko.rdf" out="${voko}/cfg/klasoj.xml"
      style="${voko}/xsl/cfg_klasoj.xsl"/>

   </target>


   <target name="red-createdb" description="kreas iniciale la sqlite-datumbazojn">
     
     <exec executable="${sqlite3}" dir="${sql_dir}">
       <arg value="${sql_dir}/revo-inx.db"/>
       <arg value="-init"/>
       <arg value="${voko}/sql/revo-skemo.sql"/>
     </exec>

     <exec executable="${sqlite3}" dir="${sql_dir}">
       <arg value="${sql_dir}/redaktantoj.db"/>
       <arg value="-init"/>
       <arg value="${voko}/sql/konto-skemo.sql"/>
     </exec>
     
   </target>

   <target name="red-smb" depends="red-preparo"
	   description="kreas vinjetojn kiel PNG">
       <apply dir="${voko.smb}" executable="${mpost}" dest="${voko.smb}">
       <srcfile/>
       <fileset dir="${voko.smb}" includes="*.mp"
		excludes="centoblecent.mp tezauro.mp vikio.mp"/>
       <mapper type="glob" from="*.mp" to="*.svg"/>
     </apply>

     <apply dir="${voko.smb}" executable="${rsvgconv}" dest="${voko.smb}" verbose="true">
       <arg value="-w"/>
       <arg value="100"/>
       <arg value="-h"/>
       <arg value="100"/>
       <arg value="-o"/>
       <targetfile/>
       <srcfile/>
       <fileset dir="${voko.smb}" includes="*.svg"/>
       <mapper type="glob" from="*.svg" to="*.png"/>
     </apply>

   </target>


   <target name="red-js" depends="red-preparo"
	   description="kompilas javoskripto-fontojn per google-closure-compiler">
     <java jar="${closure-compiler}" classpath="${closure.classpath}" fork="true">
<!--       
       <arg value="- -compilation_level"/>
       <arg value="WHITESPACE_ONLY"/>
    -->   
       <arg value="--dependency_mode"/>
       <arg value="LOOSE"/>

       <arg value="--js_module_root"/>
       <arg value="${js_src}"/>

       <arg value="--entry_point"/>
       <arg file="${js_src}/ui_kreo.js"/>
<!--
       <arg value="- -externs"/>
       <arg value="https://code.jquery.com/jquery-3.2.1.min.js"/>
       <arg value="- -externs"/>
       <arg value="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
       <arg value="- -externs"/>
       <arg value="https://code.jquery.com/ui/1.12.1/themes/south-street/jquery-ui.css"/>
-->
       <arg value="--js"/>
       <arg value="${js_src}/*.js"/>

       <arg value="--js_output_file"/>
       <arg file="${web}/redaktilo-gen.js"/>

     </java>
   </target>

   
</project>
   











